# /etc/nginx/conf.d/{{ domain }}.conf
 
server {
  # Listen on all interfaces on both IPv4 & IPv6 on port 80 
  listen 0.0.0.0:80;
  listen [::]:80;

  # Wait for {{ domain }} and his aliases
  server_name {{ domain }} {{ domain-aliases }};

  # Include location directive for Let's Encrypt ACME Challenge
  include /etc/nginx/snippets/letsencrypt-acme-challenge.conf;
  
{% if https %}
  # Redirect to secure https
  return 301 https://$host$request_uri;  
{% else %}
  # Proxy to the backend container
  location / {
    proxy_pass http://{{ container }}:80;
  }
{% endif %}
}

{% if https %}
server {
  # Listen on all interfaces on both IPv4 & IPv6 on port 443 with http/2
  listen 0.0.0.0:443 ssl http2;
  listen [::]:443 ssl http2;

  # Wait for {{ domain }} and his aliases
  server_name {{ domain }} {{ domain-aliases }};

  # Get the SSL certificates
  ssl_certificate /etc/ssl/certs/{{ domain }}.pem;
  ssl_certificate_key /etc/ssl/private/{{ domain }}.key;

  # Tell the User Agent to always use HTTPS and to pin the key.
  add_header Strict-Transport-Security "max-age=15552000; preload";
  #add_header Public-Key-Pins 'pin-sha256="{{ hpkp-pin }}"; max-age=2592000';

  # Proxy to the backend container
  location / {
    proxy_pass http://{{ container }}:80;
  }
}
{% endif %}

